<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>攝政面具 — 互動敘事地圖</title>
<style>
:root {
  --bg: #0a0a14;
  --bg2: #10101e;
  --bg3: #1a1a2e;
  --text: #e8e4f0;
  --text2: #9088a8;
  --text3: #584e70;
  --accent: #d4a017;
  --accent2: #6d28d9;
  --accent-glow: rgba(212,160,23,0.15);
  --accent2-glow: rgba(109,40,217,0.15);
  --border: #2a2440;
  --card: #12101e;
  --card-hover: #1a1830;
  --warm: #f59e0b;
  --green: #4ade80;
  --tag-char: #f472b6;
  --tag-loc: #4ade80;
  --tag-action: #f97316;
  --tag-cond: #a78bfa;
  --radius: 10px;
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Georgia', 'Segoe UI', system-ui, 'Noto Sans TC', serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  height: 100vh;
  overflow: hidden;
}
.app { display: flex; height: 100vh; flex-direction: column; }

/* === Game Banner === */
.game-banner {
  background: linear-gradient(135deg, #1a0e2e 0%, #2a1840 40%, #14102a 80%, #0a0a14 100%);
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}
.game-banner::before {
  content: '';
  position: absolute;
  top: -50%; right: -5%;
  width: 350px; height: 350px;
  background: radial-gradient(circle, rgba(212,160,23,0.08), transparent 60%);
  pointer-events: none;
  animation: shimmer 5s ease-in-out infinite;
}
.game-banner::after {
  content: '';
  position: absolute;
  bottom: -40%; left: 10%;
  width: 280px; height: 280px;
  background: radial-gradient(circle, rgba(109,40,217,0.06), transparent 60%);
  pointer-events: none;
}
@keyframes shimmer {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.08); }
}
.banner-accent-line {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), var(--accent), transparent);
  opacity: 0.5;
}
.banner-top { display: flex; align-items: center; gap: 16px; position: relative; z-index: 1; }
.banner-icon {
  width: 56px; height: 56px;
  border-radius: 14px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
  flex-shrink: 0;
  box-shadow: 0 4px 20px rgba(212,160,23,0.3);
}
.banner-text h1 {
  font-size: 26px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 1px;
  font-family: 'Georgia', serif;
}
.banner-text h1 .gold { color: var(--accent); text-shadow: 0 0 20px rgba(212,160,23,0.4); }
.banner-text .subtitle {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  margin-top: 2px;
  font-style: italic;
}
.banner-stats {
  display: flex; gap: 16px; flex-wrap: wrap;
  margin-top: 12px;
  font-size: 12px;
  color: rgba(255,255,255,0.5);
  position: relative; z-index: 1;
}
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-item b { color: var(--accent); }

/* === Toolbar === */
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.search-wrap {
  position: relative;
  flex-shrink: 1;
  min-width: 140px;
}
.search-wrap::before {
  content: '\1F50D';
  position: absolute;
  left: 10px; top: 50%;
  transform: translateY(-50%);
  font-size: 13px;
  pointer-events: none;
  z-index: 1;
}
.search-box {
  padding: 6px 14px 6px 32px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  width: 240px;
  flex-shrink: 1;
  min-width: 140px;
  transition: border-color 0.2s, box-shadow 0.2s;
  font-family: 'Segoe UI', system-ui, sans-serif;
}
.search-wrap .search-box { width: 100%; padding-left: 32px; }
.search-box:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.search-box::placeholder { color: var(--text3); }
.toolbar-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 10px;
}
.toggle-row {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--text2);
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
  font-family: 'Segoe UI', system-ui, sans-serif;
}
.toggle-row input { accent-color: var(--accent); cursor: pointer; width: 14px; height: 14px; }
.toggle-row:hover { color: var(--text); }
.view-toggle { display: flex; gap: 3px; }
.view-btn {
  padding: 5px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  font-family: 'Segoe UI', system-ui, sans-serif;
}
.view-btn:hover { background: var(--bg3); color: var(--text); }
.view-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  box-shadow: 0 2px 8px rgba(212,160,23,0.3);
}

/* === Content === */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px 60px;
  scroll-behavior: smooth;
}

/* === Group Headers === */
.group-header {
  width: 100%;
  background: linear-gradient(135deg, var(--bg3), var(--bg2));
  padding: 14px 20px;
  margin: 16px 0 4px 0;
  border-radius: var(--radius);
  position: sticky;
  top: 0; z-index: 10;
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 12px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  transition: border-color 0.2s;
}
.group-header:first-child { margin-top: 0; }
.group-header:hover { border-color: var(--accent); }
.group-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}
.group-arrow {
  font-size: 10px;
  color: var(--text3);
  transition: transform 0.2s;
  flex-shrink: 0;
}
.group-arrow.open { transform: rotate(90deg); }
.group-info { flex: 1; min-width: 0; }
.group-header h2 {
  font-size: 16px; font-weight: 600; color: #fff;
  margin: 0; border: none; padding: 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.group-header .group-name-en {
  font-size: 11px; color: var(--text3); margin-top: 1px; font-style: italic;
}
.group-header .group-stats {
  font-size: 11px; color: var(--text2); flex-shrink: 0;
  display: flex; align-items: center; gap: 8px;
}
.group-header .group-stats b { color: var(--accent); }
.group-body { display: none; padding: 2px 0; }
.group-body.open { display: block; }

/* Group themes */
.group-header[data-theme="Character Profiles"] { background: linear-gradient(135deg, #1a1040, var(--bg2)); border-left: 3px solid var(--accent2); }
.group-header[data-theme="Introduction"] { background: linear-gradient(135deg, #1a1808, var(--bg2)); border-left: 3px solid var(--accent); }
.group-header[data-theme="Lore & Background"] { background: linear-gradient(135deg, #0a1a1a, var(--bg2)); border-left: 3px solid #14b8a6; }
.group-header[data-theme="Main Story (Peru)"] { background: linear-gradient(135deg, #1a1020, var(--bg2)); border-left: 3px solid #ec4899; }
.group-header[data-theme="Other"] { background: linear-gradient(135deg, #141418, var(--bg2)); border-left: 3px solid #64748b; }
.group-header[data-theme="Story Branch"] { background: linear-gradient(135deg, #101a14, var(--bg2)); border-left: 3px solid #22c55e; }

/* === Passage Cards === */
.passage {
  background: var(--card);
  padding: 14px 18px;
  margin: 4px 0;
  border-radius: 8px;
  border-left: 3px solid transparent;
  transition: all 0.2s;
  position: relative;
}
.passage:hover {
  border-left-color: var(--accent);
  background: var(--card-hover);
}
.passage-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}
.passage-title {
  font-size: 13px; font-weight: 600;
  color: var(--accent);
  flex: 1; min-width: 0;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  font-family: 'Segoe UI', system-ui, sans-serif;
}
.passage .pid {
  font-size: 10px; color: var(--text3);
  font-family: 'Consolas', monospace; flex-shrink: 0;
}
.passage .tag-row { margin-bottom: 6px; display: flex; flex-wrap: wrap; gap: 3px; }
.passage .tag {
  display: inline-block;
  padding: 1px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 500;
}
.tag-char { background: rgba(244,114,182,0.12); color: var(--tag-char); }
.tag-loc { background: rgba(74,222,128,0.12); color: var(--tag-loc); }
.tag-action { background: rgba(249,115,22,0.12); color: var(--tag-action); }
.tag-cond { background: rgba(167,139,250,0.12); color: var(--tag-cond); }
.tag-default { background: rgba(255,255,255,0.06); color: var(--text2); }
.passage .text {
  font-size: 15px; line-height: 1.9;
  color: var(--text);
  white-space: pre-wrap; word-break: break-word;
}
.passage .text p { margin-bottom: 8px; }
.passage .text-en {
  font-size: 12px; color: var(--text2);
  margin-top: 8px; padding-top: 8px;
  border-top: 1px dashed var(--border);
  font-style: italic; line-height: 1.6;
  white-space: pre-wrap;
  max-height: 150px; overflow: hidden;
  position: relative;
}
.passage .text-en.collapsed::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(transparent, var(--card));
  pointer-events: none;
}
.passage-img {
  max-width: 100%; max-height: 400px;
  border-radius: 8px; margin: 8px 0; display: block;
  border: 1px solid var(--border);
}
.passage .choices-row {
  margin-top: 8px; padding-top: 8px;
  border-top: 1px solid var(--border);
  display: flex; flex-wrap: wrap; gap: 4px;
}
.choice-btn {
  padding: 3px 10px;
  border-radius: 14px;
  background: var(--accent-glow);
  border: 1px solid rgba(212,160,23,0.25);
  color: var(--accent);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
}
.choice-btn:hover {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

/* === Character View (Scene View) === */
.char-section {
  margin: 12px 0;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}
.char-section-header {
  padding: 14px 18px;
  background: var(--bg2);
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; user-select: none;
  transition: background 0.15s;
}
.char-section-header:hover { background: var(--bg3); }
.char-section-avatar {
  width: 42px; height: 42px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 700; color: #fff;
  flex-shrink: 0;
}
.char-section-info { flex: 1; min-width: 0; }
.char-section-info h3 {
  font-size: 16px; font-weight: 600; color: #fff;
}
.char-section-info .meta {
  font-size: 12px; color: var(--text2);
}
.char-section-body { display: none; }
.char-section-body.open { display: block; padding: 4px 8px 8px; }

/* === Condition Tags === */
.cond-block {
  margin: 8px 0 4px 0;
  padding: 4px 8px;
  border-left: 2px solid var(--tag-cond);
  background: rgba(167,139,250,0.05);
  border-radius: 0 4px 4px 0;
}

/* === States === */
.loading {
  text-align: center; padding: 80px 20px; color: var(--text2);
}
.loading .spinner {
  display: inline-block;
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--text2); font-size: 14px;
}

/* === Scrollbar === */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* === Keyboard shortcut hint === */
.kb-hint {
  position: fixed; bottom: 12px; right: 16px;
  font-size: 10px; color: var(--text3);
  pointer-events: none; z-index: 100;
  font-family: 'Segoe UI', system-ui, sans-serif;
}
.kb-hint kbd {
  padding: 1px 4px; border-radius: 3px;
  background: var(--bg2); border: 1px solid var(--border);
  font-family: inherit;
}

/* === Mobile === */
@media (max-width: 768px) {
  .game-banner { padding: 16px; }
  .banner-text h1 { font-size: 22px; }
  .content { padding: 10px 12px 40px; }
  .passage .text { font-size: 15px; line-height: 1.9; }
  .toolbar { padding: 6px 10px; gap: 6px; }
  .search-wrap { width: 100%; }
  .search-box { width: 100%; }
  .toolbar-right { margin-left: 0; width: 100%; flex-wrap: wrap; justify-content: center; }
  .view-toggle { width: 100%; justify-content: center; }
  .group-header { padding: 10px 14px; }
  .group-header h2 { font-size: 15px; }
  .kb-hint { display: none; }
}
</style>
</head>
<body>
<div class="app">
  <div class="game-banner">
    <div class="banner-accent-line"></div>
    <div class="banner-top">
      <div class="banner-icon">&#x1F3AD;</div>
      <div class="banner-text">
        <h1><span class="gold">Regency</span> Masks</h1>
        <div class="subtitle">攝政面具 — Twine 互動敘事地圖</div>
      </div>
    </div>
    <div class="banner-stats" id="bannerStats"></div>
  </div>

  <div class="toolbar">
    <div class="search-wrap">
      <input type="text" class="search-box" id="searchBox" placeholder="搜尋段落、場景...">
    </div>
    <div class="toolbar-right">
      <label class="toggle-row">
        <input type="checkbox" id="showZh" checked>
        <span>中文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showEn">
        <span>英文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showChoices" checked>
        <span>選項</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showCond">
        <span>條件</span>
      </label>
      <div class="view-toggle">
        <button class="view-btn active" data-view="narrative" id="viewNarrative">敘事</button>
        <button class="view-btn" data-view="scene" id="viewScene">場景</button>
        <button class="view-btn" data-view="character" id="viewChar">角色</button>
      </div>
    </div>
  </div>

  <div id="filterBar" class="toolbar" style="display:none; padding:4px 16px; border-top:none;">
    <div class="filter-row" id="filterRow"></div>
  </div>

  <div class="content" id="content">
    <div class="loading">
      <div class="spinner"></div>
      <div>載入敘事數據中...</div>
    </div>
  </div>
</div>

<div class="kb-hint">
  <kbd>/</kbd> 搜尋 &nbsp; <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> 切換視圖
</div>

<script>
// ============================================================
// Regency Masks — Enhanced Narrative Viewer
// ============================================================

// === Constants ===
const CHUNK_SIZE = 60;
const CHAR_COLORS = {};
const GROUP_ICONS = {
  'Character Profiles': ['#6d28d9', '\u{1F464}'],
  'Introduction':       ['#d4a017', '\u{1F4DC}'],
  'Lore & Background':  ['#14b8a6', '\u{1F30D}'],
  'Main Story (Peru)':  ['#ec4899', '\u{1F3D4}'],
  'Other':              ['#64748b', '\u{1F4C4}'],
  'Story Branch':       ['#22c55e', '\u{1F333}']
};
const GROUP_NAMES_ZH = {
  'Character Profiles': '角色檔案',
  'Introduction': '序章',
  'Lore & Background': '世界觀與背景',
  'Main Story (Peru)': '主線故事（秘魯）',
  'Other': '其他',
  'Story Branch': '故事分支'
};

// === State ===
let DATA = null;
let searchQuery = '';
let showZh = true;
let showEn = false;
let showChoices = true;
let showCond = false;
let currentView = 'narrative';
let openSections = new Set();
let charFilter = null;

// === Data Loading ===
async function loadData() {
  try {
    const resp = await fetch('data/passages.json?v=' + Date.now());
    DATA = await resp.json();
    if (!DATA.meta.has_zh) {
      document.getElementById('showZh').parentElement.style.display = 'none';
      showZh = false;
      showEn = true;
      document.getElementById('showEn').checked = true;
    }
    init();
  } catch(e) {
    document.getElementById('content').innerHTML =
      '<div class="empty-state">載入失敗: ' + e.message + '</div>';
  }
}

// === Banner ===
function renderBanner() {
  const m = DATA.meta;
  const total = m.total || DATA.passages.length;
  const chars = m.characters || [];
  const groups = (DATA.groups || []).length;
  const zhCount = m.translated_count || DATA.passages.filter(p => p.content_zh).length;
  const pct = total > 0 ? Math.round(zhCount / total * 100) : 0;
  const totalChoices = m.total_choices || 0;

  document.getElementById('bannerStats').innerHTML =
    `<span class="stat-item"><b>${groups}</b> 分類</span>` +
    `<span class="stat-item"><b>${total.toLocaleString()}</b> 段落</span>` +
    (totalChoices > 0 ? `<span class="stat-item"><b>${totalChoices}</b> 選項</span>` : '') +
    (chars.length > 0 ? `<span class="stat-item"><b>${chars.length}</b> 角色</span>` : '') +
    `<span class="stat-item" style="color:${pct>=95?'#4ade80':'#fbbf24'}">${pct}% 已翻譯</span>`;
}

// === Filtering ===
function getFiltered() {
  let passages = DATA.passages;
  if (charFilter) {
    passages = passages.filter(p => (p.characters || []).includes(charFilter));
  }
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    passages = passages.filter(p =>
      (p.content_zh || '').toLowerCase().includes(q) ||
      (p.content || '').toLowerCase().includes(q) ||
      (p.name || '').toLowerCase().includes(q) ||
      (p.title || '').toLowerCase().includes(q) ||
      (p.group || '').toLowerCase().includes(q) ||
      (p.characters || []).some(c => c.toLowerCase().includes(q))
    );
  }
  return passages;
}

function filterByChar(name) {
  if (charFilter === name) {
    charFilter = null;
  } else {
    charFilter = name;
  }
  updateFilterBar();
  resetAndRender();
}

function updateFilterBar() {
  const bar = document.getElementById('filterBar');
  const row = document.getElementById('filterRow');
  const chars = DATA.meta.characters || [];
  if ((currentView === 'character' || charFilter) && chars.length > 0) {
    bar.style.display = 'flex';
    row.innerHTML = chars.map(c => {
      const color = CHAR_COLORS[c] || '#64748b';
      const active = charFilter === c ? ' active' : '';
      return `<button class="filter-chip${active}" style="${charFilter===c?`background:${color}22;border-color:${color};color:${color}`:''}" onclick="filterByChar('${c}')">${c}</button>`;
    }).join('') + (charFilter ? `<button class="filter-chip" style="color:var(--warm)" onclick="filterByChar(null);charFilter=null;updateFilterBar();resetAndRender();">清除</button>` : '');
  } else {
    bar.style.display = 'none';
  }
}

// === Passage Title ===
function getPassageTitle(p) {
  if (p.title && p.title.length > 2 && p.title.length < 80) return p.title;
  const name = p.name || '';
  if (name && !/^(g\d|passage_|p\d|#|\d+$)/.test(name) && name.length > 2 && name.length < 80) return name;
  if (p.content_zh) {
    const first = p.content_zh.replace(/<[^>]+>/g, '').replace(/\[.*?\]/g, '').split(/[。！？\n]/)[0].trim();
    if (first.length > 4) return first.length > 50 ? first.substring(0, 47) + '...' : first;
  }
  if (p.content) {
    const first = p.content.replace(/<[^>]+>/g, '').replace(/\[.*?\]/g, '').split(/[.!?\n]/)[0].trim();
    if (first.length > 4) return first.length > 50 ? first.substring(0, 47) + '...' : first;
  }
  return name || 'Passage ' + p.pid;
}

// === Condition Extraction ===
function extractConditions(text) {
  if (!text) return [];
  const conds = [];
  const re = /<<(?:else)?if\s+([^>]+?)>>/g;
  let m;
  while ((m = re.exec(text)) !== null) {
    conds.push(m[1].trim());
  }
  return conds;
}

// === Text Formatting ===
function formatText(s) {
  if (!s) return '';
  // Extract <img> tags
  const imgs = [];
  let safe = s.replace(/<img\s[^>]*>/gi, m => {
    const i = imgs.length;
    let tag = m;
    if (!/class=/.test(tag)) tag = tag.replace('<img', '<img class="passage-img"');
    if (!/loading=/.test(tag)) tag = tag.replace('<img', '<img loading="lazy"');
    imgs.push(tag);
    return `\x00IMG${i}\x00`;
  });
  // Strip markers
  safe = safe.replace(/\[(img|video)\]\s*/gi, '');
  safe = safe.replace(/<<[^>]*?>>/g, '');
  safe = safe.replace(/\[\[([^\]|]*?)(?:\|[^\]]*?)?\]\]/g, '');
  safe = safe.replace(/==[^=]*?==/g, '');
  safe = safe.replace(/\[OR\]/g, '\n');
  safe = safe.replace(/\n{3,}/g, '\n\n').trim();
  let html = escHtml(safe);
  html = html.replace(/\x00IMG(\d+)\x00/g, (_, i) => imgs[+i] || '');
  // Image syntaxes
  html = html.replace(/!\[img\]\(([^)]+)\)/g, '<img src="$1" class="passage-img" loading="lazy" alt="">');
  html = html.replace(/\[img\[([^\]]+?)\](?:\[[^\]]*\])?\]/g, '<img src="$1" class="passage-img" loading="lazy" alt="">');
  html = html.replace(/\[(?:image|Image):\s*([^\]]+)\]/g, '<img src="$1" class="passage-img" loading="lazy" alt="">');
  html = html.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br>');
  return '<p>' + html + '</p>';
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// === Passage HTML ===
function passageHtml(p) {
  const title = getPassageTitle(p);
  const pid = p.pid != null ? `<span class="pid">#${p.pid}</span>` : '';

  const tags = (p.tags && p.tags.length > 0)
    ? `<div class="tag-row">${p.tags.map(t => `<span class="tag tag-default">${escHtml(t)}</span>`).join('')}</div>`
    : '';

  const chars = (p.characters && p.characters.length > 0)
    ? `<div class="tag-row">${p.characters.map(c => {
        const color = CHAR_COLORS[c] || '#64748b';
        return `<span class="tag tag-char" style="background:${color}18;color:${color}" onclick="filterByChar('${c}')">${c}</span>`;
      }).join('')}</div>`
    : '';

  let condHtml = '';
  if (showCond) {
    const conds = extractConditions(p.content || '');
    if (conds.length > 0) {
      condHtml = `<div class="tag-row">${conds.slice(0, 5).map(c =>
        `<span class="tag tag-cond" title="${escHtml(c)}">${escHtml(c.length > 30 ? c.substring(0,27)+'...' : c)}</span>`
      ).join('')}</div>`;
    }
  }

  const TEXT_LIMIT = 5000;
  let textHtml = '';
  if (showZh && p.content_zh) {
    const t = p.content_zh.length > TEXT_LIMIT ? p.content_zh.substring(0, TEXT_LIMIT) : p.content_zh;
    textHtml += `<div class="text">${formatText(t)}</div>`;
  }
  if (showEn && p.content) {
    const t = p.content.length > TEXT_LIMIT ? p.content.substring(0, TEXT_LIMIT) : p.content;
    if (showZh && p.content_zh) {
      const isLong = t.length > 300;
      textHtml += `<div class="text-en${isLong ? ' collapsed' : ''}">${formatText(t)}</div>`;
    } else {
      textHtml += `<div class="text">${formatText(t)}</div>`;
    }
  }
  if (!textHtml) {
    textHtml = p.content_zh
      ? `<div class="text">${formatText(p.content_zh)}</div>`
      : p.content
        ? `<div class="text">${formatText(p.content)}</div>`
        : '<div class="text" style="color:var(--text3)">(empty)</div>';
  }

  let choicesHtml = '';
  if (showChoices && p.choices && p.choices.length > 0) {
    choicesHtml = `<div class="choices-row">${p.choices.slice(0, 20).map(c =>
      `<span class="choice-btn" title="-> ${escHtml(c.target || '')}">${escHtml(c.text)}</span>`
    ).join('')}</div>`;
  }

  return `<div class="passage">
    <div class="passage-header">
      <span class="passage-title">${escHtml(title)}</span>
      ${pid}
    </div>
    ${tags}${condHtml}${chars}${textHtml}${choicesHtml}
  </div>`;
}

// === Chunked Rendering ===
function renderChunked(container, passages, startIdx) {
  const end = Math.min(startIdx + CHUNK_SIZE, passages.length);
  let html = '';
  for (let i = startIdx; i < end; i++) {
    html += passageHtml(passages[i]);
  }
  container.insertAdjacentHTML('beforeend', html);

  if (end < passages.length) {
    const sentinel = document.createElement('div');
    sentinel.className = 'loading';
    sentinel.style.padding = '16px';
    sentinel.innerHTML = `<div style="font-size:11px;color:var(--text3)">載入更多 (${end}/${passages.length})...</div>`;
    container.appendChild(sentinel);

    const obs = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting) {
        obs.disconnect();
        sentinel.remove();
        renderChunked(container, passages, end);
      }
    });
    obs.observe(sentinel);
  }
}

// === Group helper ===
function groupPassages(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const g = p.group || '(uncategorized)';
    if (!groups.has(g)) groups.set(g, []);
    groups.get(g).push(p);
  });
  if (DATA.groups && DATA.groups.length > 0) {
    const ordered = [];
    const seen = new Set();
    DATA.groups.forEach(gi => {
      const key = gi.id || gi.name;
      if (groups.has(key)) { ordered.push([key, groups.get(key)]); seen.add(key); }
    });
    groups.forEach((v, k) => { if (!seen.has(k)) ordered.push([k, v]); });
    return ordered;
  }
  return Array.from(groups.entries()).sort((a, b) => b[1].length - a[1].length);
}

// === Narrative View (by group) ===
function renderNarrativeView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  const groups = groupPassages(passages);

  if (groups.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }

  groups.forEach(([gName, gPassages]) => {
    const isOpen = openSections.has('g:' + gName);
    const icon = GROUP_ICONS[gName] || ['#64748b', '\u{1F4C4}'];
    const nameZh = GROUP_NAMES_ZH[gName] || gName;
    const gInfo = (DATA.groups || []).find(g => g.id === gName);
    const displayNameEn = gInfo ? (gInfo.name || gName) : gName;

    const header = document.createElement('div');
    header.className = 'group-header';
    header.setAttribute('data-theme', gName);
    header.innerHTML = `
      <div class="group-icon" style="background:${icon[0]}22;color:${icon[0]}">${icon[1]}</div>
      <span class="group-arrow${isOpen ? ' open' : ''}">&#9654;</span>
      <div class="group-info">
        <h2>${escHtml(nameZh)}</h2>
        <div class="group-name-en">${escHtml(displayNameEn)}</div>
      </div>
      <div class="group-stats">
        <span><b>${gPassages.length}</b> 段落</span>
      </div>
    `;

    const body = document.createElement('div');
    body.className = 'group-body' + (isOpen ? ' open' : '');

    header.addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      header.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openSections.add('g:' + gName);
        if (!body.dataset.rendered) {
          renderChunked(body, gPassages, 0);
          body.dataset.rendered = '1';
        }
      } else {
        openSections.delete('g:' + gName);
      }
    });

    if (isOpen && !body.dataset.rendered) {
      renderChunked(body, gPassages, 0);
      body.dataset.rendered = '1';
    }

    content.appendChild(header);
    content.appendChild(body);
  });
}

// === Scene View (group -> character sub) ===
function renderSceneView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';

  if (passages.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }

  const groups = groupPassages(passages);

  groups.forEach(([gName, gPassages]) => {
    const icon = GROUP_ICONS[gName] || ['#64748b', '\u{1F4C4}'];
    const nameZh = GROUP_NAMES_ZH[gName] || gName;
    const isOpen = openSections.has('sv:' + gName);

    const charSubs = new Map();
    gPassages.forEach(p => {
      const chars = p.characters || [];
      const key = chars.length > 0 ? chars[0] : '(general)';
      if (!charSubs.has(key)) charSubs.set(key, []);
      charSubs.get(key).push(p);
    });
    const subCount = charSubs.size;

    const header = document.createElement('div');
    header.className = 'group-header';
    header.setAttribute('data-theme', gName);
    header.innerHTML = `
      <div class="group-icon" style="background:${icon[0]}22;color:${icon[0]}">${icon[1]}</div>
      <span class="group-arrow${isOpen ? ' open' : ''}">&#9654;</span>
      <div class="group-info">
        <h2>${escHtml(nameZh)}</h2>
        <div class="group-name-en">${escHtml(gName)} &middot; ${subCount} 子場景</div>
      </div>
      <div class="group-stats"><b>${gPassages.length}</b> 段落</div>
    `;

    const body = document.createElement('div');
    body.className = 'group-body' + (isOpen ? ' open' : '');

    header.addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      header.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openSections.add('sv:' + gName);
        if (!body.dataset.rendered) {
          renderSceneSubs(body, charSubs, gName);
          body.dataset.rendered = '1';
        }
      } else {
        openSections.delete('sv:' + gName);
      }
    });

    if (isOpen && !body.dataset.rendered) {
      renderSceneSubs(body, charSubs, gName);
      body.dataset.rendered = '1';
    }

    content.appendChild(header);
    content.appendChild(body);
  });
}

function renderSceneSubs(container, charSubs, groupName) {
  const sorted = Array.from(charSubs.entries()).sort((a, b) => {
    if (a[0] === '(general)') return 1;
    if (b[0] === '(general)') return -1;
    return b[1].length - a[1].length;
  });

  sorted.forEach(([charName, subPassages]) => {
    const secKey = 'ss:' + groupName + ':' + charName;
    const isOpen = openSections.has(secKey);
    const color = CHAR_COLORS[charName] || '#64748b';
    const isGeneral = charName === '(general)';

    const sub = document.createElement('div');
    sub.className = 'char-section';
    sub.style.margin = '4px 0';
    sub.innerHTML = `
      <div class="char-section-header" style="padding:10px 14px">
        <div class="char-section-avatar" style="background:${color};width:32px;height:32px;font-size:13px">
          ${isGeneral ? '?' : charName[0]}
        </div>
        <div class="char-section-info">
          <h3 style="font-size:14px">${isGeneral ? '一般場景' : escHtml(charName)}</h3>
          <div class="meta">${subPassages.length} 段落</div>
        </div>
        <span class="group-arrow${isOpen ? ' open' : ''}">&#9654;</span>
      </div>
    `;

    const subBody = document.createElement('div');
    subBody.className = 'char-section-body' + (isOpen ? ' open' : '');

    sub.querySelector('.char-section-header').addEventListener('click', () => {
      const nowOpen = subBody.classList.toggle('open');
      sub.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openSections.add(secKey);
        if (!subBody.dataset.rendered) {
          renderChunked(subBody, subPassages, 0);
          subBody.dataset.rendered = '1';
        }
      } else {
        openSections.delete(secKey);
      }
    });

    if (isOpen && !subBody.dataset.rendered) {
      renderChunked(subBody, subPassages, 0);
      subBody.dataset.rendered = '1';
    }

    sub.appendChild(subBody);
    container.appendChild(sub);
  });
}

// === Character View ===
function renderCharacterView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';

  const charMap = new Map();
  passages.forEach(p => {
    (p.characters || []).forEach(c => {
      if (!charMap.has(c)) charMap.set(c, []);
      charMap.get(c).push(p);
    });
  });

  const noChar = passages.filter(p => !(p.characters && p.characters.length > 0));

  if (charMap.size === 0 && noChar.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }

  const sorted = Array.from(charMap.entries()).sort((a, b) => b[1].length - a[1].length);

  sorted.forEach(([charName, charPassages]) => {
    if (charFilter && charFilter !== charName) return;

    const isOpen = openSections.has('c:' + charName);
    const color = CHAR_COLORS[charName] || '#64748b';
    const groups = {};
    charPassages.forEach(p => {
      const g = p.group || 'other';
      groups[g] = (groups[g] || 0) + 1;
    });
    const groupStr = Object.entries(groups).map(([k,v]) => `${GROUP_NAMES_ZH[k]||k} ${v}`).join(' / ');

    const section = document.createElement('div');
    section.className = 'char-section';
    section.innerHTML = `
      <div class="char-section-header">
        <div class="char-section-avatar" style="background:${color}">${charName[0]}</div>
        <div class="char-section-info">
          <h3>${escHtml(charName)}</h3>
          <div class="meta">${charPassages.length} 段落 | ${groupStr}</div>
        </div>
        <span class="group-arrow${isOpen ? ' open' : ''}">&#9654;</span>
      </div>
    `;

    const body = document.createElement('div');
    body.className = 'char-section-body' + (isOpen ? ' open' : '');

    section.querySelector('.char-section-header').addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      section.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openSections.add('c:' + charName);
        if (!body.dataset.rendered) {
          renderChunked(body, charPassages, 0);
          body.dataset.rendered = '1';
        }
      } else {
        openSections.delete('c:' + charName);
      }
    });

    if (isOpen && !body.dataset.rendered) {
      renderChunked(body, charPassages, 0);
      body.dataset.rendered = '1';
    }

    section.appendChild(body);
    content.appendChild(section);
  });

  if (noChar.length > 0 && !charFilter) {
    const isOpen = openSections.has('c:__none');
    const section = document.createElement('div');
    section.className = 'char-section';
    section.innerHTML = `
      <div class="char-section-header">
        <div class="char-section-avatar" style="background:var(--text3)">?</div>
        <div class="char-section-info">
          <h3>無特定角色</h3>
          <div class="meta">${noChar.length} 段落</div>
        </div>
        <span class="group-arrow${isOpen ? ' open' : ''}">&#9654;</span>
      </div>
    `;
    const body = document.createElement('div');
    body.className = 'char-section-body' + (isOpen ? ' open' : '');

    section.querySelector('.char-section-header').addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      section.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openSections.add('c:__none');
        if (!body.dataset.rendered) {
          renderChunked(body, noChar, 0);
          body.dataset.rendered = '1';
        }
      } else {
        openSections.delete('c:__none');
      }
    });
    if (isOpen && !body.dataset.rendered) {
      renderChunked(body, noChar, 0);
      body.dataset.rendered = '1';
    }
    section.appendChild(body);
    content.appendChild(section);
  }
}

// === Render Dispatch ===
function resetAndRender() {
  document.querySelectorAll('[data-rendered]').forEach(el => {
    if (!el.classList.contains('open')) el.dataset.rendered = '';
  });

  const passages = getFiltered();

  switch (currentView) {
    case 'narrative': renderNarrativeView(passages); break;
    case 'scene': renderSceneView(passages); break;
    case 'character': renderCharacterView(passages); break;
  }
}

function setActiveView(view) {
  currentView = view;
  openSections.clear();
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  const btnId = view === 'narrative' ? 'viewNarrative' : view === 'scene' ? 'viewScene' : 'viewChar';
  document.getElementById(btnId).classList.add('active');
  updateFilterBar();
  resetAndRender();
}

// === Init ===
function init() {
  renderBanner();
  updateFilterBar();

  let searchTimeout;
  document.getElementById('searchBox').addEventListener('input', e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      openSections.clear();
      resetAndRender();
    }, 300);
  });

  document.getElementById('showZh').addEventListener('change', e => { showZh = e.target.checked; openSections.clear(); resetAndRender(); });
  document.getElementById('showEn').addEventListener('change', e => { showEn = e.target.checked; openSections.clear(); resetAndRender(); });
  document.getElementById('showChoices').addEventListener('change', e => { showChoices = e.target.checked; openSections.clear(); resetAndRender(); });
  document.getElementById('showCond').addEventListener('change', e => { showCond = e.target.checked; openSections.clear(); resetAndRender(); });

  document.getElementById('viewNarrative').addEventListener('click', () => setActiveView('narrative'));
  document.getElementById('viewScene').addEventListener('click', () => setActiveView('scene'));
  document.getElementById('viewChar').addEventListener('click', () => setActiveView('character'));

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT') return;
    if (e.key === '/') { e.preventDefault(); document.getElementById('searchBox').focus(); }
    if (e.key === '1') setActiveView('narrative');
    if (e.key === '2') setActiveView('scene');
    if (e.key === '3') setActiveView('character');
    if (e.key === 'Escape') {
      document.getElementById('searchBox').blur();
      if (charFilter) { charFilter = null; updateFilterBar(); resetAndRender(); }
    }
  });

  resetAndRender();
}

loadData();
</script>
</body>
</html>
